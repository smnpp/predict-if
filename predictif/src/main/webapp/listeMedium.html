<!DOCTYPE html>
<html>
    <head>
        <title>Liste Medium</title>
        <meta charset="UTF-8">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <body>
        <h1>Predicti'IF - Liste des mediums</h1>

        <div id="head-bande">
            <div id="nav-non-connecte">
                <button id="bouton-accueil">Accueil</button>
                <button id="bouton-login">Login/Register</button>
            </div>

            <div id="nav-connecte" style="display: none;">
                <button id="bouton-accueil-connecte">Accueil</button>
                <button id="bouton-historique">Historique</button>
                <button id="bouton-profil">Profil astral</button>
                <button id="logout">Logout</button>
            </div>
        </div>

        <div id="medium-list"></div>

        <script>
            $(document).ready(function () {
                console.log("Prêt à afficher la liste des mediums.");
                var isConnected = false;
                var idClient = null;

                $.ajax({
                    url: './ActionServlet',
                    method: 'GET',
                    data: {todo: 'verifierConnexion'},
                    dataType: 'json'
                }).done(function (response) {
                    console.log("Réponse de connexion : ", response);
                    if (response.idClient) {
                        $('#nav-non-connecte').hide();
                        $('#nav-connecte').show();
                        isConnected = true;
                        idClient = response.idClient;
                    } else {
                        $('#nav-non-connecte').show();
                        $('#nav-connecte').hide();
                    }

                    $.ajax({
                        url: './ActionServlet',
                        method: 'GET',
                        data: {todo: 'listerMediums'},
                        dataType: 'json'
                    }).done(function (response) {
                        console.log("Médiums chargés avec succès.");
                        var mediumList = $("#medium-list");
                        if (response.mediums && response.mediums.length > 0) {
                            response.mediums.forEach(function (medium) {
                                var mediumHtml = `<p>Nom: ${medium.denomination}, Genre: ${medium.genre}, Description: ${medium.presentation}`;
                                if (isConnected) {
                                    mediumHtml += ` <button class="select-button" data-medium-id="${medium.id}">Sélectionner</button>`;
                                }
                                mediumHtml += `</p>`;
                                mediumList.append(mediumHtml);
                            });

                            $('.select-button').on('click', function () {
                                var mediumId = $(this).data('medium-id');
                                console.log("Médium sélectionné ID:", mediumId);
                                $.ajax({
                                    url: './ActionServlet',
                                    method: 'POST',
                                    data: {
                                        todo: 'ajouterConsultation',
                                        idClient: idClient,
                                        idMedium: mediumId
                                    },
                                    dataType: 'json'
                                }).done(function (response) {
                                    alert("Consultation ajoutée avec succès.");
                                }).fail(function (error) {
                                    console.error("Erreur lors de l'ajout de la consultation :", error);
                                    alert("Erreur lors de l'ajout de la consultation.");
                                });
                            });
                        } else {
                            mediumList.html("<p>Aucun medium trouvé.</p>");
                        }
                    }).fail(function (error) {
                        console.error("Erreur lors de la récupération des mediums :", error);
                        $("#medium-list").html("<p>Erreur lors de la récupération des mediums.</p>");
                    });
                }).fail(function (error) {
                    console.error("Erreur lors de la vérification de la connexion :", error);
                });

                $('#logout').on('click', function () {
                    $.ajax({
                        url: './ActionServlet',
                        method: 'POST',
                        data: {
                            todo: 'deconnexion'
                        },
                        dataType: 'json'
                    })
                            .done(function (response) {
                                if (response.success) {
                                    console.log("Déconnexion réussie.");
                                    window.location.href = 'index.html';
                                } else {
                                    console.error("Échec de la déconnexion :", response.message);
                                    alert("Déconnexion échouée: " + response.message);
                                }
                            })
                            .fail(function (error) {
                                console.error("Erreur lors de la déconnexion :", error);
                                alert("Erreur lors de l'appel AJAX: " + error.statusText);
                            });
                });

                $('#bouton-accueil, #bouton-accueil-connecte').on('click', function () {
                    console.log("Redirection vers la page d'accueil.");
                    window.location.href = 'index.html';
                });

                $('#bouton-login').on('click', function () {
                    console.log("Redirection vers la page de connexion.");
                    window.location.href = 'login.html';
                });

                $('#bouton-profil').on('click', function () {
                    console.log("Redirection vers le profil astral.");
                    window.location.href = 'profilAstral.html';
                });

                $('#bouton-historique').on('click', function () {
                    console.log("Redirection vers l'historique.");
                    window.location.href = 'historique.html';
                });
            });
        </script>
    </body>
</html>
